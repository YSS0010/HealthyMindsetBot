const Discord = require("discord.js");
const YTDL = require("ytdl-core");

const TOKEN = "NDM3OTkyNTc1OTYyNzEwMDE2.Db-IVw.pUStyvlzLo-DwFTFpq09D8nte3E";
const PREFIX = "$";

var bot = new Discord.Client();

var servers = {};

bot.on("ready",function(){
    console.log("Bot is Ready");
bot.on('warn', console.warn);
bot.on('error', console.error);
bot.on('disconnect', () => console.log('Disconnected, logged and will reconnect now! ...'));
bot.on('reconnecting', () => console.log('Reconnecting now!'));


});


function play(connection, message) {
    var server = servers[message.id];

    server.dispatcher = connection.playStream(YTDL(server.queue[0], {filter: "audioonly"}));

    server.queue.shift();

    server.dispatcher.on("end", function() {
        if (server.queue[0]) play(connection, message);
        else connnection.disconnect();
    })
}

var fortunes = [
    "Oo naman",
    "Nope",
    "Pwede na",
    "Sorry Paul",
];

bot.on("message", function(message){
    if (message.author.equals(bot.user)) return;

    if (!message.content.startsWith(PREFIX)) return;

    var args = message.content.substring(PREFIX.length).split(" ");

    switch (args[0].toLowerCase()) {
        case "ping" :
            message.channel.send("pong!");
            break;
        case "info" :
            message.channel.send("Healthy mindset is the wae");
            break;
        case "d":
        if (args[1])
            message.channel.send(fortunes[Math.floor(Math.random() * fortunes.length)]); 
            else message.channel.send("Invalid Arguments");
            break;
        case "embed":
            var embed = new Discord.RichEmbed()
                .addField("Test Embed")
            message.channel.sendEmbed(embed);
        case "play":
        if (args[1]) {
            message.channel.sendMessage("Needs a link!")
            return;
        }

        if (!message.member.voiceChannel) {
            message.channel.sendMessage("You need to be in a voice chat sir!")
            return;
        }

        if(!servers[message.id]) servers[message.id] = {
            queue: []
        };

            var server = servers[message.id];
        
        server.queue.push(args[1]);
        
        if (!message.voiceConnection) message.member.voiceChannel.join().then(function(connection) {
            play(connection, message);
         });

        break;

         case "skip":
            var server = servers[message.id];

            if (server.dispatcher) server.dispatcher.end();
         break;

         case "stop":
            var server = servers[message.id];

            if (message.guild.voiceConnection) message.guild.voiceConnection.disconnect();
        break;



    }
});

//music bot



bot.login(TOKEN);